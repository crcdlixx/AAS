services:
  mcp:
    build:
      context: .
      dockerfile: tools/mcp_python/Dockerfile
    image: ${DOCKERHUB_USERNAME:-local}/aas-mcp:${IMAGE_TAG:-latest}
    environment:
      MCP_HTTP_HOST: 0.0.0.0
      MCP_HTTP_PORT: 8080
      PYODIDE_LOG: ${PYODIDE_LOG:-off}
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://127.0.0.1:8080/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"
        ]
      interval: 10s
      timeout: 5s
      retries: 10

  api:
    build:
      context: .
      dockerfile: server/Dockerfile
    image: ${DOCKERHUB_USERNAME:-local}/aas-api:${IMAGE_TAG:-latest}
    env_file:
      - server/.env
    environment:
      PORT: 5174
      MCP_PYTHON_URL: http://mcp:8080/method/execute_python
    depends_on:
      mcp:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://127.0.0.1:5174/api/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"
        ]
      interval: 10s
      timeout: 5s
      retries: 10

  web:
    build:
      context: .
      dockerfile: client/Dockerfile
    image: ${DOCKERHUB_USERNAME:-local}/aas-web:${IMAGE_TAG:-latest}
    ports:
      - ${WEB_PORT:-8080}:80
    depends_on:
      api:
        condition: service_healthy
